<?xml version="1.0" ?>
<doc>
	<label auto="true" type="str" verify="true"><![CDATA[Other]]></label>
	<author auto="true" type="list" verify="true">
		<item type="str"><![CDATA[sergeyvass]]></item>
	</author>
	<date auto="true" type="str" verify="true"><![CDATA[2022-05-23, 12:00]]></date>
	<link auto="true" type="str" verify="true"><![CDATA[https://habr.com/ru/company/ruvds/blog/662944/]]></link>
	<title auto="true" type="str" verify="true"><![CDATA[Z-Uno Shield 2. Вторая попытка сделать дома «умными»]]></title>
	<categories auto="true" type="list" verify="true">
		<item type="str"><![CDATA[Блог компании RUVDS.com]]></item>
		<item type="str"><![CDATA[Прототипирование]]></item>
		<item type="str"><![CDATA[Производство и разработка электроники]]></item>
		<item type="str"><![CDATA[Умный дом]]></item>
		<item type="str"><![CDATA[DIY или Сделай сам]]></item>
	</categories>
	<key_words auto="true" type="list" verify="true">
		<item type="str"><![CDATA[ruvds_статьи]]></item>
		<item type="str"><![CDATA[diy-проекты]]></item>
		<item type="str"><![CDATA[умный дом]]></item>
		<item type="str"><![CDATA[Z-wave]]></item>
	</key_words>
	<text auto="true" type="str" verify="true"><![CDATA[В своей работе часто делаю прототипы устройств для «умных» домов на базе Z-wave. Проект Z-Uno упрощает этот процесс до уровня работы с ардуино. Подключил совместимые датчики, установил готовую библиотеку для них и написал сотню строк кода. Получил сертифицированное устройство, которое совместимо с другими устройствами Z-Wave. Но главный недостаток – нестандартная печатная плата. И весь огромный парк плат расширений для ардуино можно использовать, только подключив его проводами. Поэтому появление устройства Z-Uno shield был вопросом времени. Проведя «тщательный анализ» работы за последние годы, выяснилось: практически для каждого устройства необходимо организовать питание, подключить датчик и исполняемое устройство, написать программу, в которой нужно настроить работу с подключённой периферией. Пусть эти типовые задачи решает Shield, а мне останется больше времени на творчество и радости жизни!

Описание устройства

Кратко о том, что же «на борту» устройства:
4 силовых транзистора, каждый до 15А. Ими можно управлять светодиодной лентой, использовать в качестве реле или диммера.
4 ЦАП для управления диммерами со входом 0-10В с максимальным током 30 мА;
приёмопередатчик RS-485;
линия с подтягивающим резистором 4.7кОм для подключения датчиков по шине OneWire;
4 АЦП с индивидуальным набором делителей, для измерения напряжений до 3.3В, 5В, 12В;
небольшой участок выделен под макетную плату, на которой можно распаять простую схему.

Мощные транзисторы IRF7455 коммутируют сигналы до 30 В 15А. Устройство питается напряжением 3-24В (DC-DC MC34063), клеммники dg127-5.08-02p-14-00ah рассчитаны на ток до 15А. Поскольку все транзисторы подключены к одной клемме, то она и является узким местом, ограничивающим максимальный ток для всей платы. Остаётся либо распределить 15 А между всеми транзисторами, либо использовать только один на 15А. Жаль, нельзя поставить клеммник для «земли» под больший ток – узел перестаёт влезать в корпус на DIN рейку.

Печатная плата состоит из 4-х слоёв. Чтобы обеспечить высокий ток транзисторов, была заказана нестандартная сборка печатной платы. Внешние слои фольги толщиной 18 мкм, для пайки маленьких микросхем, а внутренние силовые, толщиной 105 мкм. Чем толще слой фольги, тем шире должны быть дорожки на печатной плате и зазоры между ними. На заводе подобные платы делаются существенно дольше.

Сильно переработана часть управления диммерами 0-10В. Эти диммеры принимают аналоговый сигнал 0-10В или 1-10В (оба варианта поддерживаются). Чем напряжение выше тем ярче горит подключённая к нему лампочка (устройство). Мало кто из производителей делает больше одного диммера в корпусе. Часто бывают задачи управления 2,4,10 диммируемыми светильниками. Проще использовать одно устройство, чем десять. В первой версии устройства был один канал и у него был очень низкий выходной ток с плохо прогнозируемым напряжением.



Достоинство схемы одно, она стоила в разы дешевле того, что сделано сейчас. Но и недостаток существенный. Её практически невозможно использовать. Хотя можно добавить третий транзистор в режиме повторителя, чтобы нагрузка не влияла на выходное напряжение, но было решено пойти более традиционным путём. Купил несколько управляющих устройств для диммеров 0-10В. Разобрал. Оказалось, что все они используют связку ЦАП+ОУ (операционный усилитель). Остановился на DAC102S085CIMM + LM358AD. ОУ может выдать до 30мА. На напряжение его выхода не влияет питающее напряжение для всей платы. Оно может быть от 12 до 24В. ЦАП работает по SPI. Для задания нового напряжения нужно послать 2 байта. Очень просто. Жаль, что из-за нехватки микросхем в мире не получилось поставить 4-х канальную микросхему. По цене и наличию было выгоднее использовать две двухканальных.

Хочу вспомнить одну историю. Когда-то давным-давно разрабатывал батареечное устройство, работающее с сетью RS485. Тогда уже знал, что существуют решения по защите микросхемы драйвера от всевозможных наводок со стороны довольно длинной сети. Но здесь, как и везде. Чем выше защита, тем она дороже. Мне разрешили поставить самую дешёвую в виде быстродействующих TVS диодов на вход микросхемы (очень мало производителей устройств для «умных домов» ставят хоть какую-то защиту). Они защищают от очень коротких импульсов высокого напряжения. На этапе тестирования устройства, на базе заказчика, на моих глазах сеть из 6 устройств перестаёт работать. В сети было моё устройство и 5 устройств заказчика. Покупные устройства, недешёвые. Причём эти устройства не работали только с моим, а между собой работали хорошо. Оказалось, что, скорее всего, кто-то, дотронулся до провода рукой и «выжег» у пяти устройств вход «B», а моё устройство выжило. Поскольку пострадавшие устройства работали от 5В, моё от 3В, то им для общения между собой хватало одной линии, а моё они уже не понимали. Экономика очень жестокая наука. Но очень хочется, чтобы в устройствах стоимостью более 10000 р., стояла защита хотя бы ценой 5 рублей.

Настройка работы джамперами

Z-Uno Shield — многофункциональное устройство. Выбор и настройка используемых функций осуществляется программно и через установку соответствующих джамперов. Из-за большого количества джамперов было решено использовать штыри для них с шагом 2мм. С ними очень неудобно работать голыми руками, но они позволяют немного сэкономить места на печатной плате.



Группа джамперов «1». Разрывает питание между Z-Uno и платой расширения: 5В и 3.3В. Это сделано по просьбам пользователей, которые опасались подключать Z-Uno к компьютеру через USB для перепрошивки, с поданным на плату расширения питанием. Группа джамперов «2». Нужна для уменьшения потребления платы расширения в режиме работы от батарейки. Разрывает питание и некоторые пины микросхемы ЦАП. Во всех остальных случаях можно оставить. Группа джамперов «3» и «4». Управление клеммниками «7, RS-A» и «8, RS-B». Их можно настроить на прямое подключение к Z-Uno и использовать как UART или обычнее пины ввода-вывода. А можно подключить через микросхему ST1408ABDR и получить интерфейс RS-485. В случае питания от батареи можно сильно уменьшить потребление, отключив питание интерфейсной микросхемы. Пока писал статью, наша команда протестировала 3 вида микросхем. Причём все они проходили тестирование, но приходилось искать новые и повторять тестирование из-за исчезновения с продажи.



Группа джамперов «5». Служит для настройки делителей напряжения для входа АЦП на Z-Uno. АЦП работает с напряжением до 3.3В, но делителями можно выбрать три диапазона: — от 0 до 3.3В; — от 0 до 5В; — от 0 до 12В. Если выбрать диапазон от 0 до 5В и попытаться измерить сигнал 0 – 12В, то ножка микроконтроллера, а возможно, и весь микроконтроллер выйдет из строя. Хочу отдельно отметить, что показания АЦП не нужно пересчитывать в вольты. Это уже удобно сделано в библиотеке, которая поставляется вместе с Z-Uno. Соединил выход задатчика диммера со входом АЦП. На картинке скриншот контроллера сети этого устройства:



В случае если нужно собрать какую-то схему на макетном поле и завести на неё сигналы от клеммников предусмотрена возможность отключения от клеммников ЦАП и линий «11», «12».



Для ЦАП нужно вынуть все джамперы, а для других линий выпаять или перекусить кусачками перемычки



Этими действиями соответствующие клеммники разрываются от Z-Uno и через монтажные отверстия их можно подключить в нужное место. За 3 года никогда не пользовался этой функцией.



Это должно упростить пайку при модернизации устройства под нужды пользователя. При этом внешний вид сильно страдать не будет и устройство по-прежнему будет помещаться в корпус.

О корпусах

Первая версия устройства поставлялась для трёх видов корпусов.

D4MG

G2104


NUB1057020

Но корпус с фланцем не пользовался популярностью. Поэтому в этой версии от него отказались, что позволило крепить печатную плату к герметичному корпусу G2104 всеми четырьмя винтами, а не двумя как раньше. В корпус на din-рейку устройство защёлкивается и винты не нужны. Для ввода проводов питания и сигналов от датчиков или управляемых устройств в герметичный корпус применяется гермоввод. Для него придётся просверлить соответствующее отверстие.



Методика производственного тестирования

На заводе после монтажа компонентов на печатные платы, узлы подвергаются внутренней приёмке (ОТК). В рекламных буклетах это специалисты разных профилей вплоть до рентгеновского контроля, но на деле происходит всё что угодно. Самое яркое впечатление (от Резонита) это заливка половины печатной платы полигоном «земли». Эта была безобидная ошибка на тестовой партии. Мы у себя тоже не сразу поняли, что под маской сплошная медь. Конечно, они переделывают свои ошибки, но на это тратится время. И за те 5 лет что я работаю с Резонитом, они не перестают удивлять.

Вот ещё случай. Тут саботаж связан с растягиванием сроков. Звонок от Резонита: «Мы нарезали провод для антенн неправильной длины, и остатков не хватит для всех устройств. Мы можем бесплатно сами купить такой же провод и доделать». Это уже была финальная операция после основного монтажа, поэтому я согласился с их предложением и переключился на другой проект. Провод есть повсюду в наличии, его легко купить, он дешёвый. Какие могут быть проблемы. Через полтора месяца стало интересно, почему платы так и не поступили на наш склад. Отдел закупки Резонита получил заказ на закупку провода. Но в его работе есть один нюанс. Они всё закупают не менее трёх недель. То, что можно закупить за один день в России, они закупают со сроком как из импортного склада. Ура! Провод поставили, отдали на монтаж. Не знаю, каким чудом, но кто-то очень дотошный выяснил, что провод чёрный, а в документации написано белый. И все действия повторились ещё раз. Это была уже партия в несколько тысяч устройств, и растянутые сроки больно ударили по нашим ожиданиям. Ошибиться могут все. И ошибаются. У нас не бывает партий больше 4000 печатных плат. Резонит находится очень близко к нам. Работаем с ним уже давно и пока менять не собираемся.

Тестирование после монтажа и перед продажей очень важный этап. Который может свести все усилия, или большую их часть к нулю. Все 4-х слойные платы на Резоните проходят проверку на целостность дорожек и короткие замыкания. На мне остаётся проверка монтажа. Если устройство выполняет все основные функции – значит монтаж был произведён правильно. Сейчас закончил сборку прототипа стенда для проверки основных функций. Он будет состоять из двух частей. Первая часть проверяет работу DC-DC преобразователя. Чтобы после подачи питания на его выходе было 5 вольт. Если на его выходе будет 12В, то тестируемая плата испортит вторую часть стенда. Стенд для прошлой версии имел производительность 40 -80 секунд на одно устройство. На фото прототипы стендов в процессе сборки:

Стенд для проверки преобразователя питания

Основной стенд

Из-за обилия проводов понять что-то тяжело. Но в таком виде на нём уже можно проверять узлы.

Выводы

Получилось сделать новую версию интересного устройства. За годы использования первой версии выявились недостатки и потребности в новых функциях, которые были решены в этой итерации. Следующую статью хочу написать о сборке стенда после производственного тестирования. Из-за маленькой предполагаемой партии и желания уменьшить цену конечного продукта, стенд будет иметь ограниченный бюджет и собираться из подручных материалов. Хочу отдельно добавить, что и Z-Uno и Z-Uno Shield очень дорогие устройства по сравнению с ESP32. И даже проигрывают ему в производительности. Так ещё и без контроллера, который ещё дороже, будут работать как обычные ардуино. Но если нужно добавить какие-то функции в уже имеющуюся систему «умного дома» на базе Z-Wave, то это решение может сэкономить как время, так и деньги.        Описание устройства Описание устройства  4 силовых транзистора, каждый до 15А. Ими можно управлять светодиодной лентой, использовать в качестве реле или диммера.
4 ЦАП для управления диммерами со входом 0-10В с максимальным током 30 мА;
приёмопередатчик RS-485;
линия с подтягивающим резистором 4.7кОм для подключения датчиков по шине OneWire;
4 АЦП с индивидуальным набором делителей, для измерения напряжений до 3.3В, 5В, 12В;
небольшой участок выделен под макетную плату, на которой можно распаять простую схему. 4 силовых транзистора, каждый до 15А. Ими можно управлять светодиодной лентой, использовать в качестве реле или диммера. 4 ЦАП для управления диммерами со входом 0-10В с максимальным током 30 мА; приёмопередатчик RS-485; линия с подтягивающим резистором 4.7кОм для подключения датчиков по шине OneWire; 4 АЦП с индивидуальным набором делителей, для измерения напряжений до 3.3В, 5В, 12В; небольшой участок выделен под макетную плату, на которой можно распаять простую схему.               Настройка работы джамперами Настройка работы джамперами                                  О корпусах О корпусах     D4MG D4MG    G2104 G2104     NUB1057020 NUB1057020        Методика производственного тестирования Методика производственного тестирования         Стенд для проверки преобразователя питания Стенд для проверки преобразователя питания    Основной стенд]]></text>
</doc>
