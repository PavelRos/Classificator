<?xml version="1.0" ?>
<doc>
	<label auto="true" type="str" verify="true"><![CDATA[Other]]></label>
	<author auto="true" type="list" verify="true">
		<item type="str"><![CDATA[the_bat]]></item>
	</author>
	<date auto="true" type="str" verify="true"><![CDATA[2022-11-21, 14:17]]></date>
	<link auto="true" type="str" verify="true"><![CDATA[https://habr.com/ru/post/700598/]]></link>
	<title auto="true" type="str" verify="true"><![CDATA[Модернизация освежителя воздуха Air Wick]]></title>
	<categories auto="true" type="list" verify="true">
		<item type="str"><![CDATA[Прототипирование]]></item>
		<item type="str"><![CDATA[Производство и разработка электроники]]></item>
		<item type="str"><![CDATA[DIY или Сделай сам]]></item>
		<item type="str"><![CDATA[Электроника для начинающих]]></item>
	</categories>
	<key_words auto="true" type="list" verify="true">
		<item type="str"><![CDATA[Air Wick]]></item>
		<item type="str"><![CDATA[модернизация]]></item>
	</key_words>
	<text auto="true" type="str" verify="true"><![CDATA[Доброго времени суток, Хабр!
Лет пять назад мы купили себе освежитель воздуха Air Wick. Я его разобрал, вытащил и выкинул плату, в надежде, что так я быстрее сделаю свою … Если Вы решите, что оно того не стоило, то я готов поспорить.
Конечно же я не разрабатывал новую плату все эти пяти лет. Вкратце это было примерно так: я попользовался устройством пару месяцев, нашел готовый проект с модернизацией платы, заказал ее по готовым герберам, собрал/прошил и понял, что это не то, что я хотел получить. И вот, по прошествии пяти лет, я достал все это из далекого забытого ящика и понял какой освежитель мне нужен.
Какой же он должен быть?
Не должен брызгать в лицо при открывании двери.
Не должен пугать детей своим «пшик» в ответственные моменты.
Желательна работа от аккумулятора и потребление должно быть низким. Индикация заряда.
Плата должна «встать» с минимальными доработками корпуса, чтобы не потерялась эстетика, если так можно выразиться про устройство в санузле.
Ненавязчивая звуковая сигнализация перед срабатыванием приветствуется.
Для чего все это нужно? Да разве не проще надавить на кнопку обычного освежителя? Это же потраченное время зря!
Нет! Если что-то начал, то нужно доделывать! Даже через несколько лет.
В интернете много подобных проектов и, казалось бы, можно было выбрать один из них, но, как обычно, хочется получить что-то свое, пусть и потратить свободное временя, которого и так нет.
Первая моя попытка (по сути, уже вторая) не увенчалась успехом. Я сделал плату на модуле ESP с WiFi, так как хотел «на ходу» менять режимы работы Air Wick, контролировать расход баллона и т.д. Наигравшись я понял, что нужно что-то проще, меньше по размерам (тот вариант не хотел влезать в корпус без его кардинальных доработок напильником) и менее энергоемкое. Тогда родилась схема ниже.
Рис.1. Схема Air Wick STM
В принципе, тут нет ничего необычного. Микроконтроллер снова взял STM32F031 (как и во многих своих разработках). У него небольшой корпус, он есть у меня в наличии и полностью меня устраивает. В качестве контроллера заряда используется дешевая микросхема LTC4054. При работе от аккумулятора необходимо переключить джамер и задействовать LDO SPX3819, так как заряженный аккумулятор имеет напряжение 4,2В.
В одной из прошлых поделок на этом же микроконтроллере я задействовал режим standby. Который реализуется всего двумя строчками кода:
DBGMCU->CR |= DBGMCU_CR_DBG_STANDBY; 
HAL_PWR_EnterSTANDBYMode();
В этом режиме потребление порядка 8uA, что мне очень понравилось и оставалось только понять, как выйти из этого «сна». Тогда пришел на ум кусочек схемы на сдвоенном диоде BAV23C. Убираем подтяжку с reset микроконтроллера и дергаем его двумя сигналами: от фототранзистора (позже выяснилось, что лучше подходит фоторезистор) и собственного GPIO. Логика топорная, но работает отлично. При включении света фоторезистор тянет reset вверх, контроллер запускается и управляет сигналом сброса уже сам. Сделано это для того, чтобы после выключения света Air Wick продолжил работать необходимое время.
Последняя версия платы выглядит так:
Рис.2. Последняя версия платы Air Wick STM
Пришлось заменить транзистор управления мотором на более мощный, так как предыдущий срабатывал крайне нестабильно и грелся.
Логика работы
В схеме задействованы два АЦП. Один измеряет заряд батарейки, второй наличие подключенного зарядного устройства (чтобы избежать незапланированного срабатывания во время процесса зарядки). Разъем для зарядки вывел в паз (предварительно его расширив) от переключателя режимов.
Рис.3. Разъем для зарядки устройства
В заводской версии железки при нажатии кнопки на корпусе Air Wick происходит срабатывание («пшик»). Я к этой функции еще добавил оповещение о заряде батарейки и пока остановился на этом варианте. После нажатия раздается 1, 2 или 3 коротких звуковых сигнала (в зависимости от заряда батареек), затем, через 1 секунду (чтобы успеть отбежать), срабатывает пшик.
В автономном режиме отслеживается включение и выключение освещения. В зависимости от, простите, времени, проведенного в санузле, может быть несколько вариантов срабатывания. Если свет был включен на менее чем 1 минуту, то после выключения света просто пикаем 30 мс бипером, чтобы понимать, что устройство живое. Если свет горел 1 – 2,5 минуты, также пикаем и делаем «пшик» один раз. Если засеченное время оказалось более 2,5 минут – пикаем и «пшикаем» два раза.
Рис.4. Размещение платы внутри корпуса
Плата встала идеально в корпус. Фоторезистор на штатном месте светодиода, SWD угловой, иначе мешает.
Рис.5. Фоторезистор
С фототранзистором не получилось сделать, так как видимо у него меньше угол обзора, хоть он и имеет линзу. Лампочки на потолке имеют цоколь GU5.3, соответственно плохо засвечивают устройство, когда оно подвешено под потолком. Фоторезистор все исправил.  
Рис.6. Устройство в корпусе
Заключение
Пользуемся устройством уже 1,5 года. Первые полгода только с батарейками. Хватает примерно на 1 месяц и неделю использования. Перешли на аккумулятор. В корпусе на проводе хорошо разместился Li-Ion LP103448 на 1800мА (для него я и выводил разъем на плате). Хватает на 3-4 недели (два взрослых, два ребенка). Первый баллон кончился примерно на 6 месяце. По итогу могу сказать, что при использовании аккумулятора устройство получается довольно экономичным (по расходу баллона).
Спасибо за внимание и до скорых встреч! Доброго времени суток, Хабр!   Лет пять назад мы купили себе освежитель воздуха Air Wick. Я его разобрал, вытащил и выкинул плату, в надежде, что так я быстрее сделаю свою … Если Вы решите, что оно того не стоило, то я готов поспорить. Конечно же я не разрабатывал новую плату все эти пяти лет. Вкратце это было примерно так: я попользовался устройством пару месяцев, нашел готовый проект с модернизацией платы, заказал ее по готовым герберам, собрал/прошил и понял, что это не то, что я хотел получить. И вот, по прошествии пяти лет, я достал все это из далекого забытого ящика и понял какой освежитель мне нужен. Какой же он должен быть? Не должен брызгать в лицо при открывании двери.
Не должен пугать детей своим «пшик» в ответственные моменты.
Желательна работа от аккумулятора и потребление должно быть низким. Индикация заряда.
Плата должна «встать» с минимальными доработками корпуса, чтобы не потерялась эстетика, если так можно выразиться про устройство в санузле.
Ненавязчивая звуковая сигнализация перед срабатыванием приветствуется. Не должен брызгать в лицо при открывании двери. Не должен брызгать в лицо при открывании двери. Не должен пугать детей своим «пшик» в ответственные моменты. Не должен пугать детей своим «пшик» в ответственные моменты. Желательна работа от аккумулятора и потребление должно быть низким. Индикация заряда. Желательна работа от аккумулятора и потребление должно быть низким. Индикация заряда. Плата должна «встать» с минимальными доработками корпуса, чтобы не потерялась эстетика, если так можно выразиться про устройство в санузле. Плата должна «встать» с минимальными доработками корпуса, чтобы не потерялась эстетика, если так можно выразиться про устройство в санузле. Ненавязчивая звуковая сигнализация перед срабатыванием приветствуется. Ненавязчивая звуковая сигнализация перед срабатыванием приветствуется. Для чего все это нужно? Да разве не проще надавить на кнопку обычного освежителя? Это же потраченное время зря! Нет! Если что-то начал, то нужно доделывать! Даже через несколько лет. В интернете много подобных проектов и, казалось бы, можно было выбрать один из них, но, как обычно, хочется получить что-то свое, пусть и потратить свободное временя, которого и так нет. Первая моя попытка (по сути, уже вторая) не увенчалась успехом. Я сделал плату на модуле ESP с WiFi, так как хотел «на ходу» менять режимы работы Air Wick, контролировать расход баллона и т.д. Наигравшись я понял, что нужно что-то проще, меньше по размерам (тот вариант не хотел влезать в корпус без его кардинальных доработок напильником) и менее энергоемкое. Тогда родилась схема ниже.  Рис.1. Схема Air Wick STM В принципе, тут нет ничего необычного. Микроконтроллер снова взял STM32F031 (как и во многих своих разработках). У него небольшой корпус, он есть у меня в наличии и полностью меня устраивает. В качестве контроллера заряда используется дешевая микросхема LTC4054. При работе от аккумулятора необходимо переключить джамер и задействовать LDO SPX3819, так как заряженный аккумулятор имеет напряжение 4,2В. В одной из прошлых поделок на этом же микроконтроллере я задействовал режим standby. Который реализуется всего двумя строчками кода: DBGMCU->CR |= DBGMCU_CR_DBG_STANDBY;  HAL_PWR_EnterSTANDBYMode(); В этом режиме потребление порядка 8uA, что мне очень понравилось и оставалось только понять, как выйти из этого «сна». Тогда пришел на ум кусочек схемы на сдвоенном диоде BAV23C. Убираем подтяжку с reset микроконтроллера и дергаем его двумя сигналами: от фототранзистора (позже выяснилось, что лучше подходит фоторезистор) и собственного GPIO. Логика топорная, но работает отлично. При включении света фоторезистор тянет reset вверх, контроллер запускается и управляет сигналом сброса уже сам. Сделано это для того, чтобы после выключения света Air Wick продолжил работать необходимое время. Последняя версия платы выглядит так: Рис.2. Последняя версия платы Air Wick STM  Рис.2. Последняя версия платы Air Wick STM Пришлось заменить транзистор управления мотором на более мощный, так как предыдущий срабатывал крайне нестабильно и грелся. Логика работы В схеме задействованы два АЦП. Один измеряет заряд батарейки, второй наличие подключенного зарядного устройства (чтобы избежать незапланированного срабатывания во время процесса зарядки). Разъем для зарядки вывел в паз (предварительно его расширив) от переключателя режимов.  Рис.3. Разъем для зарядки устройства В заводской версии железки при нажатии кнопки на корпусе Air Wick происходит срабатывание («пшик»). Я к этой функции еще добавил оповещение о заряде батарейки и пока остановился на этом варианте. После нажатия раздается 1, 2 или 3 коротких звуковых сигнала (в зависимости от заряда батареек), затем, через 1 секунду (чтобы успеть отбежать), срабатывает пшик. В автономном режиме отслеживается включение и выключение освещения. В зависимости от, простите, времени, проведенного в санузле, может быть несколько вариантов срабатывания. Если свет был включен на менее чем 1 минуту, то после выключения света просто пикаем 30 мс бипером, чтобы понимать, что устройство живое. Если свет горел 1 – 2,5 минуты, также пикаем и делаем «пшик» один раз. Если засеченное время оказалось более 2,5 минут – пикаем и «пшикаем» два раза.  Рис.4. Размещение платы внутри корпуса Плата встала идеально в корпус. Фоторезистор на штатном месте светодиода, SWD угловой, иначе мешает.  Рис.5. Фоторезистор С фототранзистором не получилось сделать, так как видимо у него меньше угол обзора, хоть он и имеет линзу. Лампочки на потолке имеют цоколь GU5.3, соответственно плохо засвечивают устройство, когда оно подвешено под потолком. Фоторезистор все исправил.    Рис.6. Устройство в корпусе Заключение Пользуемся устройством уже 1,5 года. Первые полгода только с батарейками. Хватает примерно на 1 месяц и неделю использования. Перешли на аккумулятор. В корпусе на проводе хорошо разместился Li-Ion LP103448 на 1800мА (для него я и выводил разъем на плате). Хватает на 3-4 недели (два взрослых, два ребенка). Первый баллон кончился примерно на 6 месяце. По итогу могу сказать, что при использовании аккумулятора устройство получается довольно экономичным (по расходу баллона). Спасибо за внимание и до скорых встреч! ]]></text>
</doc>
